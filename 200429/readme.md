# ハイフン区切りリストの作り方くらいまで理解できるようになる回

2020/4/29(Wed.) 20:00〜 ＠Online 東大TeX愛好会

## 問題

```
\includepdfのオプションでは，[pages=1,3-5,8]のような指定が可能である。同様に，\hoge{1,3-5,8}としたらリスト：1,3,4,5,8のそれぞれに対して処理を施すような関数を定義せよ。
```

これが今回やりたいハイフン区切りリストです。これの答えを出すのに必要な知識を全部含めながらやっていこうという企画です。

## 前半：初級者向け

LaTeXエンドユーザとして普通の¶文書作成する際にも遭遇しうる事象たちを扱います。

¶対義語は「技巧的な」

### 講義：プリミティブとマクロの違い

そもそも，コントロール・シークエンス（制御綴）とは何か。これは以前のゼミ（190605）を参照してください。ここにもコピペしておきます。

（コピペ開始）

#### そもそも，制御綴とは？

制御綴（Control Sequence）とは，`⧵`から始まる「トークン」のことです。

制御綴は，必ずしもマクロだとは限りません。制御綴は……

- マクロまたはプリミティブ（機能を発揮する）
- カウンタ（数値を格納する）
- ディメンション（寸法を格納する）
- ボックス（箱を格納する）
- トークンリスト

のいずれかである可能性があります（説明はかなりざっくり）。

（コピペここまで）

それでは，"機能を発揮するコントロール・シークエンス"であるプリミティブとマクロの違いは。

- 素のTeXが持っている"予約語"の*ような*†コントロール・シークエンス：プリミティブ

- プリミティブを組み合わせて定義する（`⧵def`する‡）ことで多様な機能を持たせたコントロール・シークエンス：マクロ

†たとえ"予約語"であっても上書きしたこと自体に対するエラーはなく上書きできてしまうのがTeX言語の恐ろしい仕様ではあります。そして，上書きしたことでその命令が使われている別の箇所にまったく予期せぬ影響を及ぼし，意味不明なエラーを吐いたり，吐かなかったり。たとえば以前，`\cup`のエイリアスとして`\or`を使おうと上書き（`⧵def⧵or{⧵cup}`）してしまい意味不明なエラーで詰んでいた人を見かけました。こういうときにエラーを吐けるように`⧵newcommand`があるんでしたね。

‡`⧵newcommand`や`⧵renewcommand`，`⧵NewDocumentCommand`，`\DeclareRobustCommand`なども内部的には`⧵def`です。

というわけで，どんなマクロも展開してゆくとプリミティブの列に分解することができます。HTMLでいう`<hr>`に相当するマクロ`\hrulefill`を例に実際にやってみます。

プリミティブの挙動についてはプリミティブの一覧表 https://www.tug.org/utilities/plain/cseq.html を確かめましょう。なお，pTeXになると，プリミティブが少し増えています：増えているものの一覧はこちらhttps://zrbabbler.hatenablog.com/entry/20160612/1465700860 。

#### \hrulefillの展開を追ってみよう

latex.ltxに次のような定義がありますから，

```tex
\def\hrulefill{\leavevmode\leaders\hrule\hfill\kern\z@}
```

`\hrulefill`が読まれると，`\leavevmode\leaders\hrule\hfill\kern\z@`に展開されます。そして，またこれを左から読んでいくと，最初に現れるのは`\leavevmode`です。これについてはlatex.ltxに次のような定義がありますから，

```TeX
\def\leavevmode{\unhbox\voidb@x}
```

`\unhbox\voidb@x\leaders\hrule\hfill\kern\z@`へと展開されます。

そしてこれをまた左から読んでいきます。最初に現れる`\unhbox`はプリミティブです。`\unhbox`は後ろにboxの番号をとって，その中身を展開する役目を果たします。たとえば，`\unhbox5`とくれば，5番の箱の中身が展開される，という形です。しかし，今回`\unhbox`の後ろに続いているのは5のような数字ではなく，`\voidb@x`という制御綴りです。このようなとき，`\unhbox`はこの制御綴りを展開し，数字が現れるのを待ちます。

```TeX
\newbox\voidb@x % permanently void box register
```

とlatex.ltxに定義されているので，`\voidb@x`にはlatex.ltxが読み込まれた時点で空いていた箱の番号の中で一番小さい番号が入っています。このあと，たとえば仮に

```tex
\setbox\voidb@x=\hbox{ほげほげ}
```

などと指定してたら，`\unhbox\voidb@x`の部分は`ほげほげ`と展開されていたことになります。今，`\voidb@x`番の箱はこのような指定を受けていない（そういうお約束にしている）ので，`\unhbox\voidb@x`した結果，出てくるのは「無」です。結局何も出てこないなら一体なぜこんなことをするのかという話ですが，それは今回の主眼と外れるのでやめておきます。結局，制御綴り列`\unhbox\voidb@x\leaders\hrule\hfill\kern\z@`は`\leaders\hrule\hfill\kern\z@`に変化します。

次にこれを左から読むと，最初に現れるのは`\leaders`です。これは*プリミティブ*で，次のような文法をもっています。

```tex
\leaders<箱またはrule(線)><繰り返す(伸ばす)長さ> 
```

今，`\leaders\hrule\hfill`の部分が，`\hrule`というrule（デフォルトで使用しているので太さ0.4pt）を，`\hfill`の長さだけ伸ばすという指定になっています。これで，紙面上に横線がビーッとでます。なお，`\hrule`や`\hfill`はプリミティブであるため，これ以上展開してから使われるというわけではないです。ここ，さっきの`\voidb@x`の場合とは違うところです。

最後に残るのは`\kern\z@`です。ここで，左から読んでいきますが，`\kern`がプリミティブです。これは後ろに長さ（`0.25in`とか）をとって，それだけの横方向スペースを空ける役目をします。しかし今回後ろに続いているのは長さではなく`\z@`という制御綴りなので，長さが出てくるまでこの制御綴りを展開します。latex.ltxに次のように定義があります。

```tex
\newdimen\z@ \z@=0pt % can be used both for 0pt and 0
```

よって，`\z@`はディメンションに属する制御綴りで，`0pt`に等しいです。よって，`\kern\z@`は一回展開されて`\kern0pt`となります。そして，0ptの水平方向スペースをあけてくれます。0ptの水平スペースは一見意味がないようですが，ここは今回の主眼と外れるのでその意味については省きます。

この作業をやってみた感想は？

- TeXはプリミティブになるまで執念強く左側から順に展開してゆく

ことが理解できればよいですね。今回登場した主要な制御綴りの中で，

- プリミティブ：`\unhbox`，`\hrule`，`\hfill`，`\kern`
- マクロ（展開された）：`\hrulefill`，`\leavevmode`

のように分類できることがわかるでしょう。

### \makeatletter と \makeatother は何をしているのか

普通なら，`\voidb@x`や`\z@`が１塊の制御綴とみなされることはないはずです。カテゴリコード表を確認すると@がカテゴリコード11（英文字：Letter）ではなく12（その他の欧文文字：Other）だからです。制御綴の中でも，コントロール・ワードになるための条件を今一度復習しておきましょう。

（コピペ開始）

コントロール・ワード：`⧵`＋カテゴリコード11，16，17，19の文字が続く限り

例）`⧵word`，`⧵見出しWord`，……

（コピペここまで）

ここで，`\makeatletter`を高らかに宣言します。すると，これはlatex.ltxに定義されている次のようなマクロであるので，

```tex
\def\makeatletter{\catcode`\@11\relax}
```

@のカテゴリコードが11（英文字）に変更されます。makeatletterが「Make @ Letter」たる所以ですね。すると，`\voidb@x`や`\z@`といった制御綴がしっかりと機能します。また，@を含んだ制御綴を使わない時にはわかりづらくなってしまうので，ちゃんと`\makeatother`で戻してあげましょう。これもlatex.ltxで次のように定義されています。

```tex
\def\makeatother{\catcode`\@12\relax}
```

@のカテゴリコードが12（その他）に戻されますね。

というわけで，普段の文章中で，`\@for`や`\@tfor`などの@つきマクロを使いたい場合には，`\makeatletter`と`\makeatother`で挟んであげる必要があります。そこを１塊と認識してもらうために必要なステップです。なお，`\usepackage`でスタイルファイルを読み込んだ場合，そのスタイルファイルの読み込みの前後に`\makeatletter`と`\makeatother`が自動挿入されるようになっています。よって，次の標語を覚えておきましょう。

**普段の文章書くときは，@付き命令を`\makeatletter`と`\makeatother`で挟むこと！スタイルファイルやパッケージを書くときには挟む必要なし！**

実を言うと，@付き命令は，エンドユーザーが使うことを本来想定していない命令ってことなんです。`\@for`や`\@tfor`は便利なので（私の周りのエンドユーザーには）使う人も多いですが，エンドユーザーが使うことは実は想定されていないですね。

問題：`\makeatletter`と`\makeatother`を忘れて文章中で`\@for`や`\@tfor`を使うとどういう意味になってしまうか。latex.ltxを参考に考えてみよう。

### 基本的なif文の書き方

```tex
%if節の基本文法
\ifXXX<条件>
<trueの時の処理>
\else <falseの時の処理> %else節は省略可能
\fi
```

`\ifXXX`にはいくつか種類があります。`\ifnum`，`\ifmmode`（前回紹介した），`\ifx`，`\iftrue`，`\iffalse`などなど……

さらに，`\newif`を使えば自分だけの条件分岐スイッチを作ることもできます。

### TeX式カウンタの復習

カウンタは整数値を格納するためのものです。

```tex
\newcount\hoge
\hoge=1 %hogeの中身は1になった
\the\hoge %紙面に1を出力
\advance\hoge2 %hogeの中身は1+2=3になった
\the\hoge %紙面に3を出力
\hoge=10 %hogeの中身は10になった
```

のような使い方をします。`\multiply`による掛け算や`\divide`による割り算もあります。

### \ifnum と\loop〜\repeat

上の続きで，

```tex
\ifnum\hoge>5
That's true.
\else That's not true.
\fi
```

と書けば，`That's true.`が出てきますね。この`\ifnum`（主にこれ，ただし他のif系命令とでもよい）と組み合わせて使うのが`\loop`〜`\repeat`です。これちょっと特殊で，`\repeat`は`\fi`を内在したマクロなので`\fi`を書きません。次のように使います。

```tex
\newcount\hoge
\hoge=1
\loop
\the\hoge 回目
\ifnum\hoge<10
\advance\hoge1
\repeat
```

1回目 2回目 3回目 4回目 5回目 6回目 7回目 8回目 9回目 10回目のように表示されるはず。

### 展開制御を追う実習（これができるかはデバッグ力を大きく左右する）

前回オススメした練習でやりましょう

## 後半：中級者向け以上講座

### \ifx の使い方と\ifthenelse の便利さ

次のコードはなぜうまくいかないのか説明せよ。not sameになってしまう。

the same *top-level* expansionではないから

```tex
\def\A{\B}
\def\B{\kern}
\def\a{\b}
\def\b{\kern}
\ifx\A\a
same
\else
not same
\fi
```

`\ifthenelse`はこれをあまり気にしなくてもよいので楽！sameがでる。

```tex
\def\A{\B}
\def\B{\kern}
\def\a{\b}
\def\b{\kern}
\ifthenelse{\equal{\A}{\a}}{same}{not same}
```

### \def によるパターンマッチ

```
\def\hoge#1#2-#3#4{ここ#1，そこ#2，あそこ#3，どこか#4です。}
\hoge8090-5890
->ここ 8，そこ 090，あそこ 5，どこか 8 です。90
\def\hoge#1#2-#3#4:{ここ#1，そこ#2，あそこ#3，どこか#4です。}
\hoge8090-5890:
->ここ 8，そこ 090，あそこ 5，どこか 890 です。
```

コロンのようなおしまい記号を用意しておくと良い。

munepiさんより：おしまい記号としては`\@nil`を使うことが多いです（latex.ltxでは）

### Hyphlist.styを読む

読みました。

- `\HyphList@Degrade`は，`#3`がハイフンかどうかで場合分けしても良い

- munepiさんより：展開後の生のリスト`10,30-31,1000-1005,3000,3209`を`\Hyphlist`に与えると保証できるのであれば，このままでよいが，`10,30-31,1000-1005,3000,3209`を格納した別の命令を与える可能性もあるので，それを考慮してあげられるとなおよい