# マクロを定義してみよう！（\def,\newcommand,\NewDocumentCommand）

2019/6/5(Wed.) 18:00〜 初級者ゼミ 19:00〜 中上級者ゼミ ＠駒場キャンパス 東大TeX愛好会

<!--- environmentについては扱いましょうかね・・・ --->

<!--- 扱う予定でしたが時間的に無理でした --->

<!--- \long については後で出てくるので扱っていただきたいです。 --->

<!--- 了解です，その場で扱いました --->

## 初級者講座 (Oura M.)

同じ階層にとってもナイーブに直打ちした sample.tex を用意しました。

直打ちだって必ずしも悪ではありませんが，やはりマクロをうまく使いこなすと文書作成が捗ります。なぜ文章作成の上でマクロが便利なのか，実際の文書を例にとって実習していきましょう。

### 先ずは単純な置き換えマクロから（18:20〜18:30）

sample.tex を書いたのは 川崎ほげお さんのようですが，結婚や養子縁組により名字がもうすぐ 石川 に変わるかもしれないとのことです。名前をいちいち探して置換するのは漏れが出たら嫌ですね。一括置換で対応しようにも，地名の「川崎」まで置換されてしまいます。

####名字を登録する！

次の(1)(2)のどちらかの方法で，名字を登録したマクロ`\myouji`を定義してみましょう。`\begin{document}`の直後に(1)(2)のいずれかを書きます。

`\def\myouji{川崎}`……(1)TeX式

`\newcommand{\myouji}{川崎}`……(2)LaTeX式

以降は`\myouji `と書くことでそこが`川崎`に置換されるようになります。

sample_1.tex に答えを示しました。まずは自分でやってみましょう。

名字が 石川 に変わっても，最初の定義のところ（3行目）を１箇所書き換えればよいだけになりました。

###引数をとるマクロを作ってみよう－基本（18:30〜18:45）

sample_1.tex においてたとえば最後の見出しは

`\vskip13pt\noindent{\Large\gtfamily 授業内容}`

となっていますが，毎回

`\vskip13pt\noindent{\Large\gtfamily`〜`}`

を打つのは長ったらしいですね。見出しのスタイルを変更したくなった時にも，いちいち全ての見出しについて書き換えなくてはいけません。

`\midashi{授業内容}`

とでも書けば済むようにマクロ`\midashi`を定義してみましょう。

`\begin{document}`の直後に(1)(2)のいずれかを書きます。

`\def\midashi#1{\vskip13pt\noindent{\Large\gtfamily #1}}`……(1)TeX式

`\newcommand{\midashi}[1]{\vskip13pt\noindent{\Large\gtfamily #1}}`……(2)LaTeX式

`#1`は第１引数を意味します。引数を複数取る場合には`#1`，`#2`，`#3`，……と続いていきます（後述）。(2)の`[1]`は，引数が１つであることを意味します。

こう書けば，以降は`\midashi{ナントカカントカ}`と書くことでそこが`\vskip13pt\noindent{\Large\gtfamily ナントカカントカ}`に置換されるようになります。

sample_2.tex に答えを示しました。まずは自分でやってみましょう。

### 引数をとるマクロを作ってみよう－応用（18:45〜19:10）

同様に，濃度や平衡定数を書くのを簡単にするマクロを考えてみましょう。現状，酢酸の濃度を出力するのに

- 数式モード外では`$\left[\mathrm{CH_3COOH}\right]$`
- 数式モード中では`\left[\mathrm{CH_3COOH}\right]`

と書く必要がありますね。（`\left`，`\right`はカッコの大きさを調整するコマンド）

一律に`\noudo{CH_3COOH}`と書けば済むようにできないでしょうか。

**★ADVANCED★ 数式モードかどうかで処理の場合分け**

 `\ifmmode`[数式モード中の時の処理]`\else`[数式モード外の時の処理]`\fi`構文

ですので……答えは次のようになります。

```sample_3.tex
%%%%%%(1)TeX式
\def\noudo#1{\ifmmode
\left[\mathrm{#1}\right]%数式モード中の時の処理
\else
$\left[\mathrm{#1}\right]$%数式モード外の時の処理
\fi}
%%%%%%(2)LaTeX式
\newcommand{\noudo}[1]{\ifmmode
\left[\mathrm{#1}\right]%数式モード中の時の処理
\else
$\left[\mathrm{#1}\right]$%数式モード外の時の処理
\fi}
```

さらに，平衡定数の方も同様に定義してあげて，sample_3.texとなります。

### 作ったマクロたちをスタイルファイルにまとめよう（19:10〜19:20）

今まで作ったマクロたちの定義を眺めてみましょう。

```latex
\newcommand{\myouji}{川崎}
\newcommand{\midashi}[1]{\vskip13pt\noindent{\Large\gtfamily #1}}
\newcommand{\noudo}[1]{\ifmmode
\left[\mathrm{#1}\right]%
\else
$\left[\mathrm{#1}\right]$%
\fi}
\newcommand{\heikou}[1]{\ifmmode
K_{\mathrm{a(#1)}}%
\else
$K_{\mathrm{a(#1)}}$%
\fi}
```

このうち，`\myouji`の定義の中身「川崎」はこの先書き換える可能性がありますが，残りを書き換える可能性は低そうです。スタイルファイルに書き出してすっきりさせましょう。

hogeo.sty に書き出しました。

これらのマクロは，プリアンブル部（`\documentclass`と`\begin{document}`の間）に`\usepackage{hogeo}`とすることで読み込めます。sample_4.texです。

**★ADVANCED：学部何年生かを自動計算しよう★**

今は2019年6月。川崎さんは2015年4月入学だから，2019-2015+(6<4?0:1)=5〔年生〕ということになります。この計算も自動化してしまいましょう。

次のソースコードを解読してみてください。解説は，sample_5.texにコメントで付けてあります。

```latex
\newcount\gakunen 
\gakunen=\year　
\advance\gakunen-2015
\ifnum\the\month<4
\relax
\else
\advance\gakunen1
\fi

自己紹介をします。2015年東大入学なので，現在学部の\the\gakunen 年生です。
```

来年も同じプリントを使うなら，こうしておくと安心です（留年しなければ……）。

### 制御綴を作るのに使える文字は？（19:20〜19:40）

#### そもそも，制御綴とは？

制御綴（Control Sequence）とは，`⧵`から始まる「トークン」のことです。

制御綴は，必ずしもマクロだとは限りません。制御綴は……

- マクロまたはプリミティブ（機能を発揮する）
- カウンタ（数値を格納する）
- ディメンション（寸法を格納する）
- ボックス（箱を格納する）
- トークンリスト

のいずれかである可能性があります（説明はかなりざっくり）。では，「トークン」とは？

#### 「トークン」とは?

TeXが認識する「ひとかたまり」のことです。次の３種類があります。

- 制御綴：`⧵`から始まるもの。さらに，「コントロール・ワード」と「コントロール・シンボル」に分けられる。

  - コントロール・ワード：`⧵`＋カテゴリコード11，16，17，19の文字が続く限り

    例）`⧵word`，`⧵見出しWord`，……

  - コントロール・シンボル：`⧵`＋カテゴリコード11，16，17，19以外の1文字

    例）`⧵#`，`⧵。`，`⧵⧵`……

- パラメタトークン：`#1`，`#2`，……`#9`

- 文字トークン：上記以外の部分

#### カテゴリコード

トークンの境界を正しく認識するためには，カテゴリコードの理解が欠かせません。後でワトソンさんのブログを読んでおきましょう：

https://blog.wtsnjp.com/2017/03/31/tex-by-topic2/

今は，カテゴリコード11，16，17，19が何かだけわかっていれば大丈夫です。

- カテゴリコード11：ABCDE……Z，abcde……z
- カテゴリコード16：漢字
- カテゴリコード17：かな
- カテゴリコード19：ハングル

コントロール・ワードを終わらせるためにはこれ以外の文字を続ける必要があります。

その際，「 （半角スペース）」だけは特別で，後ろにいくつ続けても無視されます。「←」はカテゴリコード18の文字なので，

（例）`\あア漢Aa    ←%半角スペース4個続けた`と，`\あア漢Aa ←%半角スペース1個だけ`，`\あア漢Aa←%半角スペースいれてない`はすべて同じ意味です。

#### トークン分解の練習問題

トークンの列にわけよ。また，除去しても意味の変わらない半角スペースを指摘せよ。

```
\def\あア#1{#1だな} \あア漢Aa    \あア41\あア\あア\$あアs:)  {\Large 78回}
```



## 今までのマクロ定義の弱点（以下，Y.Miz）19:50〜

<!---大浦さんへ：問題点などあれば書き換えてください<(_ _)>-->

ここまでは```\def```，```\newcommand```を紹介したが……

- `\def`の問題点
  
  - そのマクロが定義済みか否かにかかわらず，命令を上書きしてしまう。（なんと`\def\def`のような命令も作成可能）
- オプション引数なども作ることが出来るが，`\@ifnextchar`や`\@ifstar`などを使ってゴリゴリやる必要があり，多少面倒。
  
- `\newcommand`の問題点
  - オプション引数を１つしか，しかも１つめの引数しかとれない。
  ```
  \newcommand\マクロ名[引数の個数][オプション引数のデフォルト値]{マクロの定義}
  ```
  のように。
    - 例
    ```
    \newcommand\chikoku[3][8時30分]{#2くんが#3に着いたのは#1です。}
    ```
    ↓
    ```
    \chikoku[9時ちょうど]{太郎}{学校}
     -> 太郎くんが学校に着いたのは9時ちょうどです。
    ```
    ```
    \chikoku{次郎}{会社}
     -> 次郎くんが会社に着いたのは8時30分です。
    ```

→もっと自由度の高いマクロ定義がしたい！ということで・・・

## Xparseパッケージ



### 提供されているマクロ（環境は除く）
`\NewDocumentCommand`，`\RenewDocumentCommand`，`\ProvideDocumentCommand`，`\DeclareDocumentCommand`，`\NewExpandableDocumentCommand`，`\RenewExpandableDocumentCommand`，`\ProvideExpandableDocumentCommand`，`\DeclareExpandableDocumentCommand`

全てのマクロに関して書き方は同じ。
```
\NewDocumentCommand\マクロ名{引数指定}{マクロの定義}
```


### マクロごとの説明


- `\NewDocumentCommand`

  LaTeX標準でいう`\newcommand`と同じような働き。マクロが定義済みの時はエラーを吐く。

- `\RenewDocumentCommand`

  LaTeX標準でいう`\renewcommand`と同じような働き。つまり，定義済みのマクロを書き換える。

- `\ProvideDocumentCommand`

  LaTeX標準でいう`\providecommand`と同じような働き。つまり，定義しようとしたマクロが未定義の時のみ定義する。

- `\DeclareDocumentCommand`

  TeXでいう`\def`と同じような働き。つまり，定義しようとしたマクロがすでに定義済みか否かにかかわらず，上書きして書き換える。

- `ほにゃららExpandableDocumentCommand`

  上記のそれぞれに`Expandable`をつけたもの。そもそもxparseはLaTeX3チームによるexpl3言語の概念が入り込んでおり（xparse.styを読むと分かる）そのexpl3における「完全展開可能」なマクロを作るためのもの。難しいし自分でもはっきりと理解できていないので飛ばします。


### 引数の指定方法

ここがxparseのなかでも相当に使いやすい箇所です。xparseでは引数の個数などを指定するのでは無く，***引数一つ一つについて***，オプション引数か必須引数かなどを指定できる。

- 指定方法の例：
  ```
  \NewDocumentCommand\マクロ名{m O{hoge} o m+ r(] }{マクロの定義}
  ```
  この意味についてであるが，
  - 第１引数：必須引数。
  - 第２引数：オプション引数。デフォルトの値は`hoge`
  - 第３引数：オプション引数。デフォルトの値はなく，値が入っていない場合は`NoValue`を返す。
  - 第４引数：必須引数。且つ，この引数は長い引数で，改行を挟むことができる。
  - 第５引数：必須引数。ただし，引数は(から]までの中身

こういった，非常に自由度の高いマクロを定義することが出来る。この引数の指定方法について，以下で述べる。

- 必須引数
  - `m`…一般的な引数で，一つのトークンで無い場合は{}で囲まれます。  
  - `r<char1><char2>`…必須引数ですが，引数の範囲の開始が`<char1>`で，終了が`<char2>`になります。もし`<char1>`が見つからなければ`-NoValue-`マーカーが挿入され，エラーを吐きます
  - `R<char1><char2>{<default>}`…必須引数ですが，引数の範囲の開始が`<char1>`で，終了が`<char2>`になります。もし`<char1>`が見つからなければ`-NoValue-`マーカーのかわりに`{default}`が挿入され，エラーを吐きます。（rとの実用上の違いが分かりません。）
  - `v`…引数を**verbatim** なものとして扱います。（つまり，普段は特殊文字として扱われる文字も引数として扱えるようになる）引数は{}で囲うか，`%,\,#,{,},␣`以外の同じ文字で囲みます。
  - `b`…環境なので省略
- オプション引数
  - `o`…一般的なオプション引数で，[]で囲われます。省略された場合は`-NoValue-`を返します。
  - `d<char1><char2>`…必須引数の`m`と`r`のような関係がオプション引数で言う`o`と`d`で，必須引数で言う`r`のように，引数の開始と終了を`<char1>``<char2>`で指定可能です。省略された場合は`-NoValue-`を返します。
  - `O{<default>}`…`o`と同じですが，省略された場合は{}内のデフォルト値を返します。
  - `D<char1><char2>{default}`…`d`と同じですが，省略された場合は{}内のデフォルト値を返します。
  - `s`…star（`*`）の判定を行います。`*`が存在する場合は`\BooleanTrue`，存在しない場合は`\BooleanFalse`となります。
  - `t<char>`…`s`の，★以外を`<char>`によって指定出来るヴァージョンです。
  - `e{<char>}`…よく分かりません・・・
  - `E{<char>}{<default>}`…よく分かりません・・・

- その他
  - 引数に`+`を指定することで，長い引数の指定が可能になります。例えば，`m+`のように使います。
  - `>prosessor`に関してはまだよく分かりません・・・


### NoValue の際の条件分岐

xparseでは先ほど`NoValue`を返しうる場合，あるいは`\BooleanTrue``\BooleanFalse`を返しうる場合を紹介しましたが，その結果を基に条件分岐する`\IfValueT`，`\IfValueF`，`\IfValueTF`，`\IfNoValueT`，`\IfNoValueF`，`\IfNoValueTF`，`\IfBooleanT`，`\IfBooleanF`，`\IfBooleanTF`が用意されています。
以下のように使います。
```
\IfNoValueTF{<argument>}{<true code>}{<false code>}
```
もちろん，TやFのみの場合は，片方の場合のみの動作を指定します。